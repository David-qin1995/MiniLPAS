# 🔍 本地运行失败原因分析

## 📋 诊断结果

经过诊断，发现了以下问题：

### ❌ 问题1: Java版本错误

**现象**:
- 当前系统使用Java 8 (`openjdk version "1.8.0_412"`)
- 项目要求Java 21
- 运行中的Java进程使用Java 8，导致服务无法启动

**原因**:
- 系统PATH中的Java是Java 8
- JAVA_HOME环境变量指向不存在的路径，但仍然被某些程序使用

**解决方案**:
```powershell
# 1. 清除错误的JAVA_HOME
Remove-Item Env:\JAVA_HOME -ErrorAction SilentlyContinue

# 2. 让Gradle自动下载和管理Java 21
# build.gradle.kts 中已配置 toolchain，会自动处理
```

### ❌ 问题2: JAVA_HOME路径不存在

**现象**:
- JAVA_HOME设置为: `D:\code\MiniLPAS\zulu21.46.19-ca-jdk21.0.9-win_x64`
- 该路径不存在

**解决方案**:
- 清除JAVA_HOME，不设置它
- Gradle会使用toolchain自动下载Java 21到用户目录

### ❌ 问题3: 编译产物不存在

**现象**:
- `web-backend\build\libs\*.jar` 不存在
- `local-agent\build\libs\*.jar` 不存在

**原因**:
- 之前的编译因为Java版本问题失败
- 或者还没有编译过

**解决方案**:
```powershell
# 清除JAVA_HOME后重新编译
Remove-Item Env:\JAVA_HOME -ErrorAction SilentlyContinue

cd web-backend
.\gradlew.bat clean build bootJar --no-daemon

cd ..\local-agent
.\gradlew.bat clean build --no-daemon
```

### ❌ 问题4: 服务未正常运行

**现象**:
- 端口8080空闲（后端未启动）
- 端口3000空闲（前端未启动）
- 有一个Java 8进程在运行，但服务无响应

**原因**:
- Java 8无法运行Spring Boot 3应用（需要Java 17+）
- 服务启动失败

**解决方案**:
- 停止错误的Java进程
- 使用正确的Java版本重新启动

## ✅ 修复步骤

### 自动修复（推荐）

运行修复脚本：
```powershell
.\修复并启动.ps1
```

### 手动修复

#### 步骤1: 停止所有相关进程
```powershell
Get-Process -Name java,node -ErrorAction SilentlyContinue | Stop-Process -Force
```

#### 步骤2: 清除错误的JAVA_HOME
```powershell
Remove-Item Env:\JAVA_HOME -ErrorAction SilentlyContinue
```

#### 步骤3: 编译后端
```powershell
cd web-backend
.\gradlew.bat clean build bootJar --no-daemon
cd ..
```

#### 步骤4: 编译代理
```powershell
cd local-agent
.\gradlew.bat clean build --no-daemon
cd ..
```

#### 步骤5: 启动服务

**方式1: 使用脚本**
```powershell
.\启动服务.ps1
```

**方式2: 手动启动（3个终端）**

终端1 - 后端:
```powershell
cd web-backend
.\gradlew.bat bootRun
```

终端2 - 代理:
```powershell
cd local-agent
.\gradlew.bat run
```

终端3 - 前端:
```powershell
cd web-frontend
npm run dev
```

## 🔍 验证修复

### 检查Java版本
```powershell
# Gradle使用的Java版本会在编译时显示
cd web-backend
.\gradlew.bat --version
```

### 检查服务状态
```powershell
# 检查端口
Get-NetTCPConnection -LocalPort 8080,3000

# 测试API
Invoke-RestMethod http://localhost:8080/api/devices/status

# 访问前端
# 浏览器打开: http://localhost:3000
```

## 📝 预防措施

1. **不要手动设置JAVA_HOME**
   - 让Gradle自动管理Java版本
   - build.gradle.kts中的toolchain配置会自动处理

2. **使用Gradle Wrapper运行服务**
   - `.\gradlew.bat bootRun` 而不是直接运行JAR
   - Gradle会确保使用正确的Java版本

3. **检查系统Java**
   - 如果系统有多个Java版本，优先使用Gradle管理的版本
   - 清除错误的JAVA_HOME设置

## 💡 关键点

- ✅ **Spring Boot 3需要Java 17+**（项目使用Java 21）
- ✅ **Gradle Toolchain会自动下载Java 21**（首次运行需要时间）
- ✅ **清除JAVA_HOME让Gradle自动管理**
- ✅ **使用Gradle Wrapper启动服务，而非直接运行JAR**

---

**总结**: 主要问题是Java版本不匹配。清除JAVA_HOME并让Gradle自动管理Java版本即可解决。

 LEGE



