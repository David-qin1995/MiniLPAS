# MiniLPAS 下一代系统设计文档（v2）

## 1. 目标与范围

- 面向对象：eSIM 管理平台（Web 管理端 + 本地 Agent）
- 本次升级目标：
  - 架构分层清晰、接口稳定、易于扩展与运维
  - 强化可靠性（重试/限流/缓存/幂等/可观测）
  - 容器化/自动化部署（宝塔/自建）
  - 健康度与性能指标可视化

## 2. 总体架构

```
┌─────────────────────────────┐
│           前端(React)        │  ↔  Nginx 反代（/ → 前端, /api,/ws → 后端）
└───────────────┬─────────────┘
                │HTTP/WS
┌───────────────▼─────────────┐
│         后端(Spring Boot)    │  ↔  Actuator/Metrics/Prometheus
│  REST API / WebSocket / 缓存  │
└───────────────┬─────────────┘
                │WS
┌───────────────▼─────────────┐
│         本地 Agent(Kotlin)   │  ↔  pcscd/读卡器/LPAC
└─────────────────────────────┘
```

- 反代策略（宝塔）：
  - `/` → 前端(8081)
  - `/api/` `/ws/` → 后端(8080)
- Agent 同机直连：`MINILPA_SERVER_WS_URL=ws://127.0.0.1:8080/ws/agent`

## 3. 模块与职责

- 前端（web-frontend）
  - UI：Profiles、Notifications、Chip、Settings
  - 事件：订阅 `/ws/client`，Progress/Response 驱动进度与自动刷新
  - API 基址：默认 `/api`，支持 `VITE_API_BASE_URL` 覆盖

- 后端（web-backend）
  - 控制器：`/api/profiles` `/api/notifications` `/api/chip` `/api/devices`
  - Agent 通道：`/ws/agent`（接入/命令/进度转发），`/ws/client`（前端订阅）
  - 可观测：Actuator、Prometheus、结构化日志、请求ID(MDC)
  - 可靠性：重试（指数退避）、并发互斥（同会话 Semaphore）、短 TTL 缓存（Caffeine）
  - 配置化：`BackendProperties`（超时、重试、TTL）

- 本地 Agent（local-agent）
  - 与后端 WS 建链、注册（agent-connect）
  - 通过 LPAC 执行业务（下载/启用/禁用/删除/通知处理/芯片信息/设备选择）
  - 运行模式：容器内 pcscd + libccid，或挂载宿主 pcscd Socket/USB

## 4. 关键设计

### 4.1 接口稳定性
- 统一响应：`ApiResponse{ success,data,message,error,code }`
- 错误码：`BAD_REQUEST/VALIDATION_ERROR/INTERNAL_ERROR`
- 参数校验：JSR-380 + 自定义校验（ICCID/SMDP/IMEI）

### 4.2 幂等与互斥
- 写操作互斥：同一 Agent 会话通过 `Semaphore(1)` 序列化
- 结果缓存：读操作 2~5s TTL，写后即时失效

### 4.3 重试与超时
- `RetryUtils` 指数退避：默认重试 2 次，后端可配置
- 命令级超时：下载 > 常规操作

### 4.4 WebSocket 事件
- agent → backend：`response/progress`，按 requestId 回传
- backend → client：`progress/agent-response` 广播
- 前端：进度解析（文本/百分比）、步骤累积（最多 8）

### 4.5 日志与链路
- MDC 注入 `X-Request-Id`，响应头回传
- 关键埋点：命令耗时、成功率；启动/路径/错误

## 5. 数据模型（摘要）

- Profile：`iccid,state(enabled/disabled),nickname,serviceProviderName,profileName`
- Notification：`seq,operation(install/enable/disable/delete),iccid,notificationAddress`
- ChipInfo：`eid,defaultSmdp,iccid(optional)`
- DownloadRequest：`smdp,matchingId,confirmCode?,imei?`

## 6. 部署与运维

### 6.1 容器化
- Runtime（后端）：`eclipse-temurin:21-jre`，端口 8080
- Runtime（前端）：`nginx:alpine`，端口 8081
- Runtime（Agent）：`eclipse-temurin:21-jre` + `pcscd/libccid`，host 网络

### 6.2 CI/CD（GitHub Actions）
- 镜像：GHCR（backend/frontend/agent）
- 宝塔一键部署：SSH 步骤在服务器写入 `/www/wwwroot/minilpa/{web,agent}/docker-compose.yml` 并 `up -d`
- Secrets：`SSH_HOST/SSH_USER/SSH_KEY/SSH_PORT(opt)`、`MINILPA_SERVER_WS_URL(opt)`

### 6.3 Nginx（宝塔）
```
location /      { proxy_pass http://127.0.0.1:8081; }
location /api/  { proxy_pass http://127.0.0.1:8080/api/; proxy_http_version 1.1; }
location /ws/   { proxy_pass http://127.0.0.1:8080/ws/; proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection "upgrade"; }
```

### 6.4 管理脚本
- `deploy/manage.sh`：菜单模式；优先 Docker Compose（`/www/wwwroot/minilpa/{web,agent}/docker-compose.yml`），降级 systemd

## 7. 安全设计

- 凭证：仅私钥（OpenSSH）存入 GitHub Secrets；服务器仅放公钥
- 反代：仅暴露 80/443，后端/前端/Agent 走 host 网络内环
- 敏感日志脱敏：ICCID、token 片段
- CORS：仅同域或特定域（默认放宽，可在生产收紧）

## 8. 可观测与告警

- Actuator：`/actuator/health` `/metrics` `/prometheus`
- 指标：`minilpa.command.duration{type}`；缓存命中率（后续扩展 Caffeine metrics）
- 日志：结构化，按请求ID关联
- 告警：Prometheus + Alertmanager（建议项）

## 9. 性能与扩展

- 多 Agent：后端会话注册表（UUID → sessionId）；API 支持 `?agentId=` 路由
- 横向扩展：后端/前端容器可多副本（后端 WS 需 sticky 或外置会话/队列）
- 大并发：互斥保证单 Agent 串行；读请求命中短 TTL 缓存减压

## 10. 迁移与兼容

- API 兼容：保留既有路径与响应模型
- 部署迁移：先上线后端/前端，再启用 Agent 容器（host 网络），Nginx 生效后切流
- 回滚：镜像标签回退 + compose 回滚

## 11. 风险与缓解

- 读卡器/LPAC 环境差异：提供“宿主 pcscd 直通”和“容器自带 pcscd”双方案
- WS 反代失败：检查 Upgrade/Connection/HTTP/1.1
- CI/CD SSH 失败：检查 Secrets、私钥格式、authorized_keys 权限

## 12. Roadmap（v2+）

- v2.1：
  - OpenAPI 文档/前端类型自动生成
  - Caffeine metrics + 缓存命中率面板
- v2.2：
  - 指标 P95/P99、错误码细化映射
  - 事件总线（领域事件）与审计日志
- v2.3：
  - 多副本/粘性会话方案与分布式会话（Redis）
  - 灰度发布/蓝绿部署指导

## 13. 附录

- 关键默认配置：
  - `minilpa.command.timeout-ms=30000`
  - `minilpa.command.download-timeout-ms=120000`
  - `minilpa.command.retries=2`
  - `minilpa.cache.profiles-ttl-ms=2000`
  - `minilpa.cache.notifications-ttl-ms=2000`
  - `minilpa.cache.chip-info-ttl-ms=5000`

- 常用命令：
```
docker compose -f /www/wwwroot/minilpa/web/docker-compose.yml up -d
docker compose -f /www/wwwroot/minilpa/agent/docker-compose.yml up -d
curl -s http://127.0.0.1:8080/api/devices/status
```
