# 🚀 CI/CD 快速开始指南 - 3 步完成配置

## 📋 你需要的准备

- ✅ GitHub 账号（已有）
- ✅ 宝塔服务器（已有）
- ✅ 服务器的 IP 地址和 root 密码

---

## 第一步：生成 SSH 密钥（在本地电脑执行）

在 PowerShell 中执行以下命令：

```powershell
ssh-keygen -t rsa -b 4096 -C "github-ci-cd" -f $HOME\.ssh\baota_github_key -N '""'
```

**执行结果**：
- ✅ 会生成两个文件（不需要你做任何操作）
- ✅ 文件保存在：`C:\Users\你的用户名\.ssh\`

---

## 第二步：把公钥添加到服务器

### 方法 1：通过宝塔面板（推荐，最简单）

1. **登录宝塔面板**
2. **点击左侧菜单：安全**
3. **点击：SSH管理**
4. **点击：添加SSH密钥**
5. **查看你的公钥**，在 PowerShell 执行：
   ```powershell
   Get-Content $HOME\.ssh\baota_github_key.pub
   ```
6. **复制显示的内容**（一长串以 `ssh-rsa` 开头的）
7. **粘贴到宝塔面板**的 SSH 密钥输入框
8. **点击保存**

✅ 完成！

### 方法 2：通过命令行（如果你会 SSH 连接）

```powershell
# 1. 查看公钥
Get-Content $HOME\.ssh\baota_github_key.pub

# 2. SSH 登录到服务器
ssh root@你的服务器IP

# 3. 在服务器上执行（粘贴刚才看到的公钥）
echo "公钥内容" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
```

---

## 第三步：在 GitHub 配置 Secrets（最后一步）

### 步骤 3.1：进入 GitHub 设置

1. **打开浏览器**，访问：
   ```
   https://github.com/David-qin1995/MiniLPAS
   ```
2. **点击仓库顶部的：Settings**（设置）
3. **左侧菜单找到：Secrets and variables** → **Actions**
4. **点击：New repository secret**（新建仓库密钥）

### 步骤 3.2：添加 4 个密钥

#### 密钥 1：`BAOTA_HOST`

**Name**（名称）输入：`BAOTA_HOST`

**Secret**（值）输入：你的服务器 IP 地址
```
例如：192.168.1.100
或者：baota.example.com（如果用域名）
```

点击 **Add secret** 保存

---

#### 密钥 2：`BAOTA_USER`

**Name**（名称）输入：`BAOTA_USER`

**Secret**（值）输入：`root`

点击 **Add secret** 保存

---

#### 密钥 3：`BAOTA_SSH_KEY`

**Name**（名称）输入：`BAOTA_SSH_KEY`

**Secret**（值）输入：私钥内容

**如何获取私钥**：

1. **在 PowerShell 执行**：
   ```powershell
   Get-Content $HOME\.ssh\baota_github_key | Set-Clipboard
   ```
   这会自动把私钥复制到剪贴板

2. **在 GitHub 的 Secret 输入框中粘贴**（按 Ctrl+V）

3. **点击 Add secret** 保存

**⚠️ 注意**：私钥很长，包含多行，要完整复制，包括：
   - 开头的 `-----BEGIN OPENSSH PRIVATE KEY-----`
   - 中间的所有内容
   - 结尾的 `-----END OPENSSH PRIVATE KEY-----`

---

#### 密钥 4：`BAOTA_SSH_PORT`（可选）

**Name**（名称）输入：`BAOTA_SSH_PORT`

**Secret**（值）输入：`22`

（如果服务器 SSH 端口不是 22，改为实际端口）

点击 **Add secret** 保存

---

## ✅ 完成！测试一下

### 测试方法 1：推送代码（自动触发）

```powershell
# 在项目目录执行
git commit --allow-empty -m "测试 CI/CD"
git push origin master
```

### 测试方法 2：手动触发

1. **访问**：https://github.com/David-qin1995/MiniLPAS/actions
2. **点击左侧：CI/CD - Deploy to Baota**
3. **点击右上角：Run workflow**
4. **点击绿色的：Run workflow** 按钮

### 查看结果

- ✅ **绿色对勾** = 成功！
- ❌ **红色叉号** = 失败（点击查看错误信息）

---

## 🐛 如果出错了怎么办？

### 错误：SSH 连接失败

**检查**：
1. `BAOTA_HOST` 是否正确（能 ping 通吗？）
2. `BAOTA_SSH_PORT` 是否正确
3. 服务器防火墙是否开放 SSH 端口

### 错误：权限被拒绝

**检查**：
1. 公钥是否正确添加到服务器（重新执行第二步）
2. 服务器上执行：`chmod 600 ~/.ssh/authorized_keys`

### 错误：找不到文件

**检查**：
- 服务器上 `/www/wwwroot/minilpa` 目录是否存在
- 首次部署需要先运行 `install.sh` 脚本

---

## 📝 配置清单（检查一下）

配置完成后，确认以下项目：

- [ ] ✅ 已生成 SSH 密钥对
- [ ] ✅ 公钥已添加到服务器（宝塔面板或命令行）
- [ ] ✅ GitHub 已配置 `BAOTA_HOST`（服务器IP/域名）
- [ ] ✅ GitHub 已配置 `BAOTA_USER`（通常是 root）
- [ ] ✅ GitHub 已配置 `BAOTA_SSH_KEY`（完整私钥）
- [ ] ✅ GitHub 已配置 `BAOTA_SSH_PORT`（端口号）
- [ ] ✅ 已测试 SSH 连接（可选，但推荐）

---

## 💡 常见问题

**Q: 私钥太长，怎么复制？**
A: 使用 PowerShell 命令自动复制：
```powershell
Get-Content $HOME\.ssh\baota_github_key | Set-Clipboard
```

**Q: 服务器 IP 在哪里看？**
A: 在宝塔面板首页，或者执行 `ip addr` 命令查看

**Q: 如果服务器端口不是 22？**
A: 在宝塔面板 → 安全 → SSH管理 中查看端口，填到 `BAOTA_SSH_PORT`

**Q: 可以测试连接吗？**
A: 可以！在 PowerShell 执行：
```powershell
ssh -i $HOME\.ssh\baota_github_key root@你的服务器IP
```

---

## 🎯 下一步

配置完成后，每次你：
1. **推送代码到 GitHub**
2. **或者手动触发工作流**

GitHub 会自动：
- ✅ 构建后端、代理、前端
- ✅ 打包文件
- ✅ 上传到服务器 `/www/wwwroot/minilpa`
- ✅ 自动重启服务

**就这么简单！** 🎉

