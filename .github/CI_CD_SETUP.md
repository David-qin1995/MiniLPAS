# CI/CD è‡ªåŠ¨åŒ–éƒ¨ç½²é…ç½®æŒ‡å—

æœ¬æŒ‡å—å°†å¸®åŠ©æ‚¨é…ç½® GitHub Actionsï¼Œå®ç°ä»£ç æäº¤åè‡ªåŠ¨æ„å»ºå¹¶éƒ¨ç½²åˆ°å®å¡”æœåŠ¡å™¨ã€‚

## ğŸ“‹ å‰ç½®è¦æ±‚

1. **GitHub ä»“åº“** - ä»£ç å·²æ¨é€åˆ° GitHub
2. **å®å¡”æœåŠ¡å™¨** - å·²å®‰è£…å®å¡”é¢æ¿çš„ Linux æœåŠ¡å™¨
3. **SSH å¯†é’¥** - ç”¨äºè¿æ¥å®å¡”æœåŠ¡å™¨çš„ SSH å¯†é’¥

## ğŸ”§ é…ç½®æ­¥éª¤

### æ­¥éª¤ 1: åœ¨æœåŠ¡å™¨ä¸Šç”Ÿæˆ SSH å¯†é’¥å¯¹ï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰

åœ¨**æœ¬åœ°å¼€å‘æœº**ä¸Šæ‰§è¡Œï¼š

```bash
ssh-keygen -t rsa -b 4096 -C "github-ci-cd" -f ~/.ssh/baota_github_key
```

è¿™å°†ç”Ÿæˆï¼š
- `~/.ssh/baota_github_key` (ç§é’¥) - éœ€è¦æ·»åŠ åˆ° GitHub Secrets
- `~/.ssh/baota_github_key.pub` (å…¬é’¥) - éœ€è¦æ·»åŠ åˆ°æœåŠ¡å™¨

### æ­¥éª¤ 2: å°†å…¬é’¥æ·»åŠ åˆ°å®å¡”æœåŠ¡å™¨

å°†å…¬é’¥å†…å®¹æ·»åŠ åˆ°æœåŠ¡å™¨çš„ `~/.ssh/authorized_keys`ï¼š

```bash
# æ˜¾ç¤ºå…¬é’¥å†…å®¹
cat ~/.ssh/baota_github_key.pub

# ç„¶åSSHç™»å½•åˆ°å®å¡”æœåŠ¡å™¨ï¼Œæ‰§è¡Œï¼š
echo "å…¬é’¥å†…å®¹" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh
```

æˆ–è€…ä½¿ç”¨å®å¡”é¢æ¿ï¼š
- å®å¡”é¢æ¿ â†’ å®‰å…¨ â†’ SSHç®¡ç† â†’ æ·»åŠ SSHå¯†é’¥
- ç²˜è´´å…¬é’¥å†…å®¹å¹¶ä¿å­˜

### æ­¥éª¤ 3: é…ç½® GitHub Secrets

1. è¿›å…¥æ‚¨çš„ GitHub ä»“åº“
2. ç‚¹å‡» **Settings** â†’ **Secrets and variables** â†’ **Actions**
3. ç‚¹å‡» **New repository secret**ï¼Œæ·»åŠ ä»¥ä¸‹å¯†é’¥ï¼š

#### å¿…éœ€ Secretsï¼š

| Secret åç§° | è¯´æ˜ | ç¤ºä¾‹å€¼ |
|------------|------|--------|
| `BAOTA_HOST` | å®å¡”æœåŠ¡å™¨IPæˆ–åŸŸå | `192.168.1.100` æˆ– `baota.example.com` |
| `BAOTA_USER` | SSHç™»å½•ç”¨æˆ·å | `root` æˆ– `www` |
| `BAOTA_SSH_KEY` | SSHç§é’¥ï¼ˆæ­¥éª¤1ç”Ÿæˆçš„ç§é’¥å†…å®¹ï¼‰ | `-----BEGIN RSA PRIVATE KEY-----...` |
| `BAOTA_SSH_PORT` | SSHç«¯å£ï¼ˆå¯é€‰ï¼Œé»˜è®¤22ï¼‰ | `22` |

#### è·å– SSH ç§é’¥å†…å®¹ï¼š

```bash
# åœ¨æœ¬åœ°å¼€å‘æœºä¸Š
cat ~/.ssh/baota_github_key
```

**é‡è¦**ï¼šå¤åˆ¶å®Œæ•´çš„ç§é’¥å†…å®¹ï¼ŒåŒ…æ‹¬ï¼š
```
-----BEGIN RSA PRIVATE KEY-----
...
-----END RSA PRIVATE KEY-----
```

### æ­¥éª¤ 4: æµ‹è¯• SSH è¿æ¥

åœ¨æœ¬åœ°æµ‹è¯•æ˜¯å¦èƒ½é€šè¿‡SSHè¿æ¥åˆ°æœåŠ¡å™¨ï¼š

```bash
ssh -i ~/.ssh/baota_github_key -p 22 root@ä½ çš„æœåŠ¡å™¨IP
```

å¦‚æœå¯ä»¥è¿æ¥ï¼Œè¯´æ˜é…ç½®æ­£ç¡®ã€‚

### æ­¥éª¤ 5: ç¡®ä¿æœåŠ¡å™¨å·²é…ç½®

ç¡®ä¿å®å¡”æœåŠ¡å™¨ä¸Šå·²ç»ï¼š
- âœ… å®‰è£…äº† Java 21
- âœ… å®‰è£…äº† PCSC-Lite
- âœ… å·²ç»è¿è¡Œè¿‡ä¸€æ¬¡ `install.sh` è„šæœ¬ï¼ˆé¦–æ¬¡éƒ¨ç½²éœ€è¦ï¼‰
- âœ… systemd æœåŠ¡æ–‡ä»¶å·²å­˜åœ¨ï¼ˆ`/etc/systemd/system/minilpa-backend.service` ç­‰ï¼‰

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### è‡ªåŠ¨è§¦å‘

æ¨é€ä»£ç åˆ° `main` æˆ– `master` åˆ†æ”¯ï¼ŒGitHub Actions ä¼šè‡ªåŠ¨ï¼š

1. âœ… æ£€å‡ºä»£ç 
2. âœ… æ„å»ºåç«¯æœåŠ¡ï¼ˆSpring Bootï¼‰
3. âœ… æ„å»ºæœ¬åœ°ä»£ç†ï¼ˆKotlinï¼‰
4. âœ… æ„å»ºå‰ç«¯ï¼ˆReact + Viteï¼‰
5. âœ… æ‰“åŒ…éƒ¨ç½²æ–‡ä»¶
6. âœ… é€šè¿‡SSHä¸Šä¼ åˆ°æœåŠ¡å™¨
7. âœ… è‡ªåŠ¨æ‰§è¡Œéƒ¨ç½²è„šæœ¬
8. âœ… é‡å¯æœåŠ¡
9. âœ… éªŒè¯éƒ¨ç½²çŠ¶æ€

### æ‰‹åŠ¨è§¦å‘

1. è¿›å…¥ GitHub ä»“åº“
2. ç‚¹å‡» **Actions** æ ‡ç­¾
3. é€‰æ‹© **CI/CD - Deploy to Baota** å·¥ä½œæµ
4. ç‚¹å‡» **Run workflow** â†’ **Run workflow**

## ğŸ“ éƒ¨ç½²ç›®å½•ç»“æ„

ä»£ç ä¼šè‡ªåŠ¨éƒ¨ç½²åˆ°æœåŠ¡å™¨ï¼š

```
/www/wwwroot/minilpa/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ minilpa-backend.jar  (è‡ªåŠ¨æ›´æ–°)
â”‚   â””â”€â”€ minilpa-agent.jar    (è‡ªåŠ¨æ›´æ–°)
â”œâ”€â”€ frontend/                (è‡ªåŠ¨æ›´æ–°)
â”œâ”€â”€ config/                  (é…ç½®æ–‡ä»¶)
â”œâ”€â”€ logs/                    (æ—¥å¿—æ–‡ä»¶)
â””â”€â”€ backup/                  (è‡ªåŠ¨å¤‡ä»½)
    â””â”€â”€ YYYYMMDD_HHMMSS/     (æ¯æ¬¡éƒ¨ç½²å‰å¤‡ä»½)
```

## ğŸ” æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—

1. **GitHub Actions æ—¥å¿—**ï¼š
   - è¿›å…¥ä»“åº“ â†’ Actions â†’ é€‰æ‹©è¿è¡Œè®°å½• â†’ æŸ¥çœ‹æ—¥å¿—

2. **æœåŠ¡å™¨æ—¥å¿—**ï¼š
   ```bash
   # æŸ¥çœ‹åç«¯æœåŠ¡æ—¥å¿—
   sudo journalctl -u minilpa-backend -f
   
   # æŸ¥çœ‹ä»£ç†æœåŠ¡æ—¥å¿—
   sudo journalctl -u minilpa-agent -f
   
   # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
   sudo systemctl status minilpa-backend
   sudo systemctl status minilpa-agent
   ```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **é¦–æ¬¡éƒ¨ç½²**ï¼šéœ€è¦å…ˆåœ¨æœåŠ¡å™¨ä¸Šæ‰‹åŠ¨è¿è¡Œ `install.sh` è„šæœ¬å®Œæˆåˆå§‹é…ç½®

2. **SSH æƒé™**ï¼šç¡®ä¿ SSH ç”¨æˆ·æœ‰ sudo æƒé™ï¼ˆéƒ¨ç½²è„šæœ¬éœ€è¦ sudoï¼‰

3. **é˜²ç«å¢™**ï¼šç¡®ä¿ GitHub Actions å¯ä»¥è¿æ¥åˆ°æœåŠ¡å™¨çš„ SSH ç«¯å£ï¼ˆ22æˆ–è‡ªå®šä¹‰ç«¯å£ï¼‰

4. **å¤‡ä»½**ï¼šæ¯æ¬¡éƒ¨ç½²å‰ä¼šè‡ªåŠ¨å¤‡ä»½æ—§æ–‡ä»¶åˆ° `backup/` ç›®å½•

5. **æœåŠ¡é‡å¯**ï¼šéƒ¨ç½²å®Œæˆåä¼šè‡ªåŠ¨é‡å¯ `minilpa-backend` å’Œ `minilpa-agent` æœåŠ¡

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: SSHè¿æ¥å¤±è´¥

- æ£€æŸ¥ `BAOTA_HOST`ã€`BAOTA_USER`ã€`BAOTA_SSH_KEY` æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥æœåŠ¡å™¨é˜²ç«å¢™æ˜¯å¦å¼€æ”¾SSHç«¯å£
- æµ‹è¯•æœ¬åœ°SSHè¿æ¥ï¼š`ssh -i ~/.ssh/baota_github_key user@host`

### é—®é¢˜2: æœåŠ¡å¯åŠ¨å¤±è´¥

- æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼š`sudo journalctl -u minilpa-backend -n 50`
- æ£€æŸ¥Javaæ˜¯å¦æ­£ç¡®å®‰è£…ï¼š`java -version`
- æ£€æŸ¥JARæ–‡ä»¶æƒé™ï¼š`ls -l /www/wwwroot/minilpa/app/*.jar`

### é—®é¢˜3: æ„å»ºå¤±è´¥

- æ£€æŸ¥ GitHub Actions æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
- ç¡®ä¿ä»£ç å¯ä»¥æ­£å¸¸æ„å»ºï¼ˆæœ¬åœ°æµ‹è¯•ï¼‰
- æ£€æŸ¥ä¾èµ–æ˜¯å¦æ­£ç¡®ï¼ˆGradleã€npmï¼‰

## ğŸ“ ç¤ºä¾‹ï¼šå®Œæ•´é…ç½®æµç¨‹

```bash
# 1. ç”ŸæˆSSHå¯†é’¥
ssh-keygen -t rsa -b 4096 -C "github-ci-cd" -f ~/.ssh/baota_github_key

# 2. æ˜¾ç¤ºå…¬é’¥ï¼ˆæ·»åŠ åˆ°æœåŠ¡å™¨ï¼‰
cat ~/.ssh/baota_github_key.pub

# 3. æ˜¾ç¤ºç§é’¥ï¼ˆæ·»åŠ åˆ°GitHub Secretsï¼‰
cat ~/.ssh/baota_github_key

# 4. æµ‹è¯•è¿æ¥
ssh -i ~/.ssh/baota_github_key root@ä½ çš„æœåŠ¡å™¨IP
```

ç„¶ååœ¨ GitHub ä¸Šè®¾ç½® Secretsï¼Œæ¨é€ä»£ç å³å¯è‡ªåŠ¨éƒ¨ç½²ï¼

