# éƒ¨ç½²å¤±è´¥æ’æŸ¥æŒ‡å—

## ğŸ” é—®é¢˜ï¼šå‰ç«¯æ˜¾ç¤º"æœªè¿æ¥ï¼Œè¯·å…ˆå¯åŠ¨æœ¬åœ°ä»£ç†æœåŠ¡"

å½“éƒ¨ç½²åå‰ç«¯æ˜¾ç¤ºæ­¤é”™è¯¯æ—¶ï¼Œè¯´æ˜ä»£ç†æœåŠ¡ï¼ˆminilpa-agentï¼‰å¯èƒ½æœªæˆåŠŸå¯åŠ¨æˆ–æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡ã€‚

---

## ğŸ“‹ ç¬¬ä¸€æ­¥ï¼šæ£€æŸ¥æœåŠ¡çŠ¶æ€

é€šè¿‡SSHç™»å½•åˆ°å®å¡”æœåŠ¡å™¨ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼š

```bash
# æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
sudo systemctl status minilpa-backend

# æ£€æŸ¥ä»£ç†æœåŠ¡çŠ¶æ€
sudo systemctl status minilpa-agent

# æ£€æŸ¥ä¸¤ä¸ªæœåŠ¡æ˜¯å¦éƒ½åœ¨è¿è¡Œ
sudo systemctl is-active minilpa-backend
sudo systemctl is-active minilpa-agent
```

### é¢„æœŸç»“æœï¼š
- âœ… `active (running)` - æœåŠ¡æ­£åœ¨è¿è¡Œ
- âŒ `inactive (deadåˆ†ä¸ºä»¥ä¸‹å‡ ç§æƒ…å†µï¼š` - æœåŠ¡æœªè¿è¡Œ
- âš ï¸ `failed` - æœåŠ¡å¯åŠ¨å¤±è´¥

---

## ğŸ“ ç¬¬äºŒæ­¥ï¼šæŸ¥çœ‹æœåŠ¡æ—¥å¿—

### æŸ¥çœ‹åç«¯æœåŠ¡æ—¥å¿—ï¼š
```bash
# æŸ¥çœ‹æœ€è¿‘çš„50è¡Œæ—¥å¿—
sudo journalctl -u minilpa-backend -n 50 --no-pager

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u minilpa-backend -f

# æŸ¥çœ‹å¯åŠ¨é”™è¯¯
sudo journalctl -u minilpa-backend --since "10 minutes ago" | grep -i error
```

### æŸ¥çœ‹ä»£ç†æœåŠ¡æ—¥å¿—ï¼š
```bash
# æŸ¥çœ‹æœ€è¿‘çš„50è¡Œæ—¥å¿—
sudo journalctl -u minilpa-agent -n 50 --no-pager

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u minilpa-agent -f

# æŸ¥çœ‹è¿æ¥é”™è¯¯
sudo journalctl -u minilpa-agent --since "10 minutes ago" | grep -i "error\|exception\|failed\|è¿æ¥"
```

---

## ğŸ”§ ç¬¬ä¸‰æ­¥ï¼šå¸¸è§é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆ

### é—®é¢˜1ï¼šä»£ç†æœåŠ¡æ— æ³•å¯åŠ¨

**æ£€æŸ¥ï¼š**
```bash
# 1. æ£€æŸ¥JARæ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -lh /www/wwwroot/minilpa/app/minilpa-agent.jar

# 2. æ£€æŸ¥Javaæ˜¯å¦æ­£ç¡®å®‰è£…
which java
java -version

# 3. æ£€æŸ¥systemdæœåŠ¡æ–‡ä»¶é…ç½®
cat /etc/systemd/system/minilpa-agent.service
```

**å¯èƒ½çš„åŸå› å’Œè§£å†³ï¼š**

#### åŸå› Aï¼šJavaè·¯å¾„ä¸æ­£ç¡®
```bash
# æ£€æŸ¥å®é™…çš„Javaè·¯å¾„
which java
# æˆ–è€…
readlink -f $(which java)

# æŸ¥çœ‹JAVA_HOME
echo $JAVA_HOME

# ä¿®æ”¹systemdæœåŠ¡æ–‡ä»¶ä¸­çš„JAVA_HOME
sudo nano /etc/systemd/system/minilpa-agent.service
# å°† Environment="JAVA_HOME=..." æ”¹ä¸ºæ­£ç¡®çš„è·¯å¾„
# ä¾‹å¦‚ï¼šEnvironment="JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64"

# é‡æ–°åŠ è½½å¹¶é‡å¯
sudo systemctl daemon-reload
sudo systemctl restart minilpa-agent
```

#### åŸå› Bï¼šJARæ–‡ä»¶æƒé™é—®é¢˜
```bash
# æ£€æŸ¥æ–‡ä»¶æƒé™
ls -la /www/wwwroot/minilpa/app/minilpa-agent.jar

# å¦‚æœéœ€è¦ï¼Œä¿®å¤æƒé™
sudo chown www:www /www/wwwroot/minilpa/app/minilpa-agent.jar
sudo chmod 644 /www/wwwroot/minilpa/app/minilpa-agent.jar
```

#### åŸå› Cï¼šå·¥ä½œç›®å½•æƒé™é—®é¢˜
```bash
# æ£€æŸ¥å·¥ä½œç›®å½•æƒé™
ls -ld /www/wwwroot/minilpa
ls -la /www/wwwroot/minilpa/app

# ä¿®å¤æƒé™
sudo chown -R www:www /www/wwwroot/minilpa
```

---

### é—®é¢˜2ï¼šä»£ç†æœåŠ¡å¯åŠ¨ä½†ç«‹å³é€€å‡º

**æ£€æŸ¥ï¼š**
```bash
# æŸ¥çœ‹è¯¦ç»†çš„å¯åŠ¨æ—¥å¿—
sudo journalctl -u minilpa-agent -n 100 --no-pager

# å°è¯•æ‰‹åŠ¨è¿è¡Œä»£ç†æœåŠ¡ï¼ˆæŸ¥çœ‹é”™è¯¯è¾“å‡ºï¼‰
cd /www/wwwroot/minilpa
sudo -u www java -Xms128m -Xmx256m -jar /www/wwwroot/minilpa/app/minilpa-agent.jar
```

**å¸¸è§é”™è¯¯ï¼š**

#### é”™è¯¯Aï¼šWebSocketè¿æ¥å¤±è´¥
```
é”™è¯¯: è¿æ¥åˆ° ws://127.0.0.1:8080/ws/agent å¤±è´¥
```

**è§£å†³ï¼š**
1. ç¡®è®¤åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œï¼š
   ```bash
   sudo systemctl status minilpa-backend
   curl http://127.0.0.1:8080/api/devices/status
   ```

2. æ£€æŸ¥åç«¯æ˜¯å¦ç›‘å¬äº†8080ç«¯å£ï¼š
   ```bash
   sudo netstat -tlnp | grep 8080
   # æˆ–è€…
   sudo ss -tlnp | grep 8080
   ```

3. å¦‚æœåç«¯æœªè¿è¡Œï¼Œå¯åŠ¨åç«¯æœåŠ¡ï¼š
   ```bash
   sudo systemctl start minilpa-backend
   sudo systemctl status minilpa-backend
   ```

4. æ£€æŸ¥é˜²ç«å¢™/å®‰å…¨ç»„æ˜¯å¦å¼€æ”¾8080ç«¯å£ï¼ˆæœ¬åœ°è¿æ¥åº”è¯¥ä¸å—å½±å“ï¼‰

#### é”™è¯¯Bï¼šé…ç½®æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ ¼å¼é”™è¯¯
**æ£€æŸ¥ï¼š**
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
ls -la /www/wwwroot/minilpa/config/application.yml

# æ£€æŸ¥é…ç½®æ–‡ä»¶å†…å®¹
cat /www/wwwroot/minilpa/config/application.yml

# æ£€æŸ¥åç«¯æœåŠ¡é…ç½®æ–‡ä»¶
sudo journalctl -u minilpa-backend -n 20 | grep -i "config\|application"
```

---

### é—®é¢˜3ï¼šåç«¯æœåŠ¡æœªè¿è¡Œ

**æ£€æŸ¥åç«¯æœåŠ¡ï¼š**
```bash
# æ£€æŸ¥åç«¯æœåŠ¡çŠ¶æ€
sudo systemctl status minilpa-backend

# å¦‚æœæœªè¿è¡Œï¼Œå¯åŠ¨å®ƒ
sudo systemctl start minilpa-backend

# æŸ¥çœ‹å¯åŠ¨æ—¥å¿—
sudo journalctl -u minilpa-backend -n 50 --no-pager
```

**å¸¸è§åŸå› ï¼š**

#### åŸå› Aï¼šJavaè·¯å¾„ä¸æ­£ç¡®
åŒé—®é¢˜1çš„åŸå› Aï¼Œä¿®æ”¹ `minilpa-backend.service` æ–‡ä»¶

#### åŸå› Bï¼šé…ç½®æ–‡ä»¶é”™è¯¯
```bash
# æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•
cat /www/wwwroot/minilpa/config/application.yml

# æ£€æŸ¥æ—¥å¿—ä¸­çš„é…ç½®é”™è¯¯
sudo journalctl -u minilpa-backend | grep -i "error\|exception\|config"
```

#### åŸå› Cï¼šç«¯å£è¢«å ç”¨
```bash
# æ£€æŸ¥8080ç«¯å£æ˜¯å¦è¢«å ç”¨
sudo lsof -i :8080
# æˆ–è€…
sudo netstat -tlnp | grep 8080

# å¦‚æœè¢«å ç”¨ï¼Œæ‰¾åˆ°å ç”¨è¿›ç¨‹å¹¶ç»“æŸå®ƒï¼Œæˆ–ä¿®æ”¹é…ç½®ä¸­çš„ç«¯å£
```

---

### é—®é¢˜4ï¼šæœåŠ¡å¯åŠ¨ä½†æ— æ³•è¿æ¥

**æµ‹è¯•è¿æ¥ï¼š**
```bash
# 1. æµ‹è¯•åç«¯API
curl http://127.0.0.1:8080/api/devices/status

# 2. æµ‹è¯•WebSocketç«¯ç‚¹ï¼ˆéœ€è¦wscatå·¥å…·ï¼‰
# å®‰è£…wscatï¼ˆå¦‚æœæœªå®‰è£…ï¼‰ï¼š
# npm install -g wscat
# ç„¶åæµ‹è¯•ï¼š
# wscat -c ws://127.0.0.1:8080/ws/agent

# 3. æ£€æŸ¥Nginxé…ç½®ï¼ˆå¦‚æœé€šè¿‡åŸŸåè®¿é—®ï¼‰
sudo nginx -t
cat /www/server/panel/vhost/nginx/esim.haoyiseo.com.conf | grep -A 10 "location /ws"
```

**å¦‚æœåç«¯æ— æ³•è®¿é—®ï¼š**
1. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
2. æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦ç»‘å®šåˆ° `0.0.0.0` è€Œä¸æ˜¯ `127.0.0.1`
3. æŸ¥çœ‹åç«¯æ—¥å¿—ä¸­çš„ç»‘å®šåœ°å€

---

## ğŸ”„ å¿«é€Ÿä¿®å¤æ­¥éª¤

å¦‚æœç¡®å®šæ˜¯ä»£ç†æœåŠ¡é—®é¢˜ï¼Œæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

```bash
# 1. åœæ­¢æ‰€æœ‰æœåŠ¡
sudo systemctl stop minilpa-backend
sudo systemctl stop minilpa-agent

# 2. æ£€æŸ¥æ–‡ä»¶å®Œæ•´æ€§
ls -lh /www/wwwroot/minilpa/app/*.jar

# 3. æ£€æŸ¥Javaç¯å¢ƒ
java -version
which java

# 4. æ£€æŸ¥systemdæœåŠ¡æ–‡ä»¶
sudo systemctl cat minilpa-backend
sudo systemctl cat minilpa-agent

# 5. é‡æ–°åŠ è½½systemdé…ç½®
sudo systemctl daemon-reload

# 6. å…ˆå¯åŠ¨åç«¯æœåŠ¡
sudo systemctl start minilpa-backend
sleep 5
sudo systemctl status minilpa-backend

# 7. ç¡®è®¤åç«¯è¿è¡Œåï¼Œå¯åŠ¨ä»£ç†æœåŠ¡
sudo systemctl start minilpa-agent
sleep 5
sudo systemctl status minilpa-agent

# 8. æŸ¥çœ‹å®æ—¶æ—¥å¿—
sudo journalctl -u minilpa-agent -f
```

---

## ğŸ“Š æ£€æŸ¥éƒ¨ç½²å®Œæ•´æ€§

```bash
# æ£€æŸ¥éƒ¨ç½²ç›®å½•ç»“æ„
tree /www/wwwroot/minilpa -L 2

# æ£€æŸ¥å…³é”®æ–‡ä»¶
ls -lh /www/wwwroot/minilpa/app/
ls -lh /www/wwwroot/minilpa/frontend/
ls -lh /www/wwwroot/minilpa/config/

# æ£€æŸ¥æœåŠ¡æ–‡ä»¶
ls -la /etc/systemd/system/minilpa-*.service

# æ£€æŸ¥æœåŠ¡æ˜¯å¦å·²å¯ç”¨
sudo systemctl is-enabled minilpa-backend
sudo systemctl is-enabled minilpa-agent
```

---

## ğŸ†˜ å¦‚æœä»¥ä¸Šéƒ½ä¸è¡Œ

### æ‰‹åŠ¨æµ‹è¯•å¯åŠ¨

```bash
å¦‚æœä¸èƒ½é€šè¿‡systemdå¯åŠ¨ï¼Œå¯ä»¥æ‰‹åŠ¨æµ‹è¯•ï¼š

# 1. åˆ‡æ¢åˆ°wwwç”¨æˆ·ï¼ˆæˆ–ä½¿ç”¨sudo -u wwwï¼‰
cd /www/wwwroot/minilpa

# 2. æ‰‹åŠ¨å¯åŠ¨åç«¯ï¼ˆåœ¨åå°ï¼‰
sudo -u www nohup java -Xms256m -Xmx512m -jar /www/wwwroot/minilpa/app/minilpa-backend.jar \
  --spring.config.location=/www/wwwroot/minilpa/config/application.yml \
  > /www/wwwroot/minilpa/logs/backend.log 2>&1 &

# 3. ç­‰å¾…åç«¯å¯åŠ¨ï¼ˆçº¦10-20ç§’ï¼‰
sleep 15

# 4. æµ‹è¯•åç«¯æ˜¯å¦å¯è®¿é—®
curl http://127.0.0.1:8080/api/devices/status

# 5. æ‰‹åŠ¨å¯åŠ¨ä»£ç†
sudo -u www nohup java -Xms128m -Xmx256m -jar /www/wwwroot/minilpa/app/minilpa-agent.jar \
  > /www/wwwroot/minilpa/logs/agent.log 2>&1 &

# 6. æŸ¥çœ‹ä»£ç†æ—¥å¿—
tail -f /www/wwwroot/minilpa/logs/agent.log
```

å¦‚æœæ‰‹åŠ¨å¯åŠ¨æˆåŠŸï¼Œè¯´æ˜é—®é¢˜åœ¨äºsystemdæœåŠ¡é…ç½®ã€‚

---

## ğŸ“ ç”Ÿæˆè¯Šæ–­æŠ¥å‘Š

æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ç”Ÿæˆå®Œæ•´çš„è¯Šæ–­ä¿¡æ¯ï¼š

```bash
cat > /tmp/minilpa-diagnostic.sh << 'EOF'
#!/bin/bash
echo "=== MiniLPA éƒ¨ç½²è¯Šæ–­æŠ¥å‘Š ==="
echo "ç”Ÿæˆæ—¶é—´: $(date)"
echo ""
echo "=== æœåŠ¡çŠ¶æ€ ==="
systemctl status minilpa-backend --no-pager -l || echo "åç«¯æœåŠ¡æœªæ‰¾åˆ°"
echo ""
systemctl status minilpa-agent --no-pager -l || echo "ä»£ç†æœåŠ¡æœªæ‰¾åˆ°"
echo ""
echo "=== æ–‡ä»¶æ£€æŸ¥ ==="
echo "åç«¯JAR:"
ls -lh /www/wwwroot/minilpa/app/minilpa-backend.jar 2>&1
echo ""
echo "ä»£ç†JAR:"
ls -lh /www/wwwroot/minilpa/app/minilpa-agent.jar 2>&1
echo ""
echo "=== Javaç¯å¢ƒ ==="
which java
java -version
echo ""
echo "=== ç«¯å£æ£€æŸ¥ ==="
netstat -tlnp | grep 8080 || echo "8080ç«¯å£æœªç›‘å¬"
echo ""
echo "=== åç«¯æ—¥å¿—ï¼ˆæœ€è¿‘20è¡Œï¼‰ ==="
journalctl -u minilpa-backend -n 20 --no-pager 2>&1 || echo "æ— æ³•è·å–åç«¯æ—¥å¿—"
echo ""
echo "=== ä»£ç†æ—¥å¿—ï¼ˆæœ€è¿‘20è¡Œï¼‰ ==="
journalctl -u minilpa-agent -n 20 --no-pager 2>&1 || echo "æ— æ³•è·å–ä»£ç†æ—¥å¿—"
EOF

chmod +x /tmp/minilpa-diagnostic.sh
sudo /tmp/minilpa-diagnostic.sh > /tmp/minilpa-diagnostic-report.txt
cat /tmp/minilpa-diagnostic-report.txt
```

ç„¶åå°†æŠ¥å‘Šå†…å®¹å‘é€ç»™æˆ‘ï¼Œæˆ‘å¯ä»¥å¸®ä½ è¿›ä¸€æ­¥åˆ†æã€‚

---

## âœ… éªŒè¯ä¿®å¤

ä¿®å¤åï¼ŒéªŒè¯æ­¥éª¤ï¼š

```bash
# 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€ï¼ˆéƒ½åº”è¯¥æ˜¯ activeï¼‰
sudo systemctl status minilpa-backend --no-pager | grep Active
sudo systemctl status minilpa-agent --no-pager | grep Active

# 2. æµ‹è¯•åç«¯API
curl http://127.0.0.1:8080/api/devices/status

# 3. æ£€æŸ¥ä»£ç†æ˜¯å¦è¿æ¥ï¼ˆåº”è¯¥è¿”å› connected: trueï¼‰
curl http://127.0.0.1:8080/api/devices/status | grep connected

# 4. æŸ¥çœ‹ä»£ç†æ—¥å¿—ï¼ˆåº”è¯¥çœ‹åˆ°"WebSocketè¿æ¥å·²å»ºç«‹"ï¼‰
sudo journalctl -u minilpa-agent -n 10 | grep -i "è¿æ¥\|connected\|websocket"
```

å¦‚æœæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼Œå‰ç«¯åº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤º"å·²è¿æ¥"çŠ¶æ€ã€‚

