# 部署失败排查指南

## 🔍 问题：前端显示"未连接，请先启动本地代理服务"

当部署后前端显示此错误时，说明代理服务（minilpa-agent）可能未成功启动或无法连接到后端服务。

---

## 📋 第一步：检查服务状态

通过SSH登录到宝塔服务器，执行以下命令检查服务状态：

```bash
# 检查后端服务状态
sudo systemctl status minilpa-backend

# 检查代理服务状态
sudo systemctl status minilpa-agent

# 检查两个服务是否都在运行
sudo systemctl is-active minilpa-backend
sudo systemctl is-active minilpa-agent
```

### 预期结果：
- ✅ `active (running)` - 服务正在运行
- ❌ `inactive (dead分为以下几种情况：` - 服务未运行
- ⚠️ `failed` - 服务启动失败

---

## 📝 第二步：查看服务日志

### 查看后端服务日志：
```bash
# 查看最近的50行日志
sudo journalctl -u minilpa-backend -n 50 --no-pager

# 实时查看日志
sudo journalctl -u minilpa-backend -f

# 查看启动错误
sudo journalctl -u minilpa-backend --since "10 minutes ago" | grep -i error
```

### 查看代理服务日志：
```bash
# 查看最近的50行日志
sudo journalctl -u minilpa-agent -n 50 --no-pager

# 实时查看日志
sudo journalctl -u minilpa-agent -f

# 查看连接错误
sudo journalctl -u minilpa-agent --since "10 minutes ago" | grep -i "error\|exception\|failed\|连接"
```

---

## 🔧 第三步：常见问题和解决方案

### 问题1：代理服务无法启动

**检查：**
```bash
# 1. 检查JAR文件是否存在
ls -lh /www/wwwroot/minilpa/app/minilpa-agent.jar

# 2. 检查Java是否正确安装
which java
java -version

# 3. 检查systemd服务文件配置
cat /etc/systemd/system/minilpa-agent.service
```

**可能的原因和解决：**

#### 原因A：Java路径不正确
```bash
# 检查实际的Java路径
which java
# 或者
readlink -f $(which java)

# 查看JAVA_HOME
echo $JAVA_HOME

# 修改systemd服务文件中的JAVA_HOME
sudo nano /etc/systemd/system/minilpa-agent.service
# 将 Environment="JAVA_HOME=..." 改为正确的路径
# 例如：Environment="JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64"

# 重新加载并重启
sudo systemctl daemon-reload
sudo systemctl restart minilpa-agent
```

#### 原因B：JAR文件权限问题
```bash
# 检查文件权限
ls -la /www/wwwroot/minilpa/app/minilpa-agent.jar

# 如果需要，修复权限
sudo chown www:www /www/wwwroot/minilpa/app/minilpa-agent.jar
sudo chmod 644 /www/wwwroot/minilpa/app/minilpa-agent.jar
```

#### 原因C：工作目录权限问题
```bash
# 检查工作目录权限
ls -ld /www/wwwroot/minilpa
ls -la /www/wwwroot/minilpa/app

# 修复权限
sudo chown -R www:www /www/wwwroot/minilpa
```

---

### 问题2：代理服务启动但立即退出

**检查：**
```bash
# 查看详细的启动日志
sudo journalctl -u minilpa-agent -n 100 --no-pager

# 尝试手动运行代理服务（查看错误输出）
cd /www/wwwroot/minilpa
sudo -u www java -Xms128m -Xmx256m -jar /www/wwwroot/minilpa/app/minilpa-agent.jar
```

**常见错误：**

#### 错误A：WebSocket连接失败
```
错误: 连接到 ws://127.0.0.1:8080/ws/agent 失败
```

**解决：**
1. 确认后端服务正在运行：
   ```bash
   sudo systemctl status minilpa-backend
   curl http://127.0.0.1:8080/api/devices/status
   ```

2. 检查后端是否监听了8080端口：
   ```bash
   sudo netstat -tlnp | grep 8080
   # 或者
   sudo ss -tlnp | grep 8080
   ```

3. 如果后端未运行，启动后端服务：
   ```bash
   sudo systemctl start minilpa-backend
   sudo systemctl status minilpa-backend
   ```

4. 检查防火墙/安全组是否开放8080端口（本地连接应该不受影响）

#### 错误B：配置文件不存在或格式错误
**检查：**
```bash
# 检查配置文件是否存在
ls -la /www/wwwroot/minilpa/config/application.yml

# 检查配置文件内容
cat /www/wwwroot/minilpa/config/application.yml

# 检查后端服务配置文件
sudo journalctl -u minilpa-backend -n 20 | grep -i "config\|application"
```

---

### 问题3：后端服务未运行

**检查后端服务：**
```bash
# 检查后端服务状态
sudo systemctl status minilpa-backend

# 如果未运行，启动它
sudo systemctl start minilpa-backend

# 查看启动日志
sudo journalctl -u minilpa-backend -n 50 --no-pager
```

**常见原因：**

#### 原因A：Java路径不正确
同问题1的原因A，修改 `minilpa-backend.service` 文件

#### 原因B：配置文件错误
```bash
# 检查配置文件语法
cat /www/wwwroot/minilpa/config/application.yml

# 检查日志中的配置错误
sudo journalctl -u minilpa-backend | grep -i "error\|exception\|config"
```

#### 原因C：端口被占用
```bash
# 检查8080端口是否被占用
sudo lsof -i :8080
# 或者
sudo netstat -tlnp | grep 8080

# 如果被占用，找到占用进程并结束它，或修改配置中的端口
```

---

### 问题4：服务启动但无法连接

**测试连接：**
```bash
# 1. 测试后端API
curl http://127.0.0.1:8080/api/devices/status

# 2. 测试WebSocket端点（需要wscat工具）
# 安装wscat（如果未安装）：
# npm install -g wscat
# 然后测试：
# wscat -c ws://127.0.0.1:8080/ws/agent

# 3. 检查Nginx配置（如果通过域名访问）
sudo nginx -t
cat /www/server/panel/vhost/nginx/esim.haoyiseo.com.conf | grep -A 10 "location /ws"
```

**如果后端无法访问：**
1. 检查防火墙设置
2. 检查后端服务是否绑定到 `0.0.0.0` 而不是 `127.0.0.1`
3. 查看后端日志中的绑定地址

---

## 🔄 快速修复步骤

如果确定是代理服务问题，执行以下步骤：

```bash
# 1. 停止所有服务
sudo systemctl stop minilpa-backend
sudo systemctl stop minilpa-agent

# 2. 检查文件完整性
ls -lh /www/wwwroot/minilpa/app/*.jar

# 3. 检查Java环境
java -version
which java

# 4. 检查systemd服务文件
sudo systemctl cat minilpa-backend
sudo systemctl cat minilpa-agent

# 5. 重新加载systemd配置
sudo systemctl daemon-reload

# 6. 先启动后端服务
sudo systemctl start minilpa-backend
sleep 5
sudo systemctl status minilpa-backend

# 7. 确认后端运行后，启动代理服务
sudo systemctl start minilpa-agent
sleep 5
sudo systemctl status minilpa-agent

# 8. 查看实时日志
sudo journalctl -u minilpa-agent -f
```

---

## 📊 检查部署完整性

```bash
# 检查部署目录结构
tree /www/wwwroot/minilpa -L 2

# 检查关键文件
ls -lh /www/wwwroot/minilpa/app/
ls -lh /www/wwwroot/minilpa/frontend/
ls -lh /www/wwwroot/minilpa/config/

# 检查服务文件
ls -la /etc/systemd/system/minilpa-*.service

# 检查服务是否已启用
sudo systemctl is-enabled minilpa-backend
sudo systemctl is-enabled minilpa-agent
```

---

## 🆘 如果以上都不行

### 手动测试启动

```bash
如果不能通过systemd启动，可以手动测试：

# 1. 切换到www用户（或使用sudo -u www）
cd /www/wwwroot/minilpa

# 2. 手动启动后端（在后台）
sudo -u www nohup java -Xms256m -Xmx512m -jar /www/wwwroot/minilpa/app/minilpa-backend.jar \
  --spring.config.location=/www/wwwroot/minilpa/config/application.yml \
  > /www/wwwroot/minilpa/logs/backend.log 2>&1 &

# 3. 等待后端启动（约10-20秒）
sleep 15

# 4. 测试后端是否可访问
curl http://127.0.0.1:8080/api/devices/status

# 5. 手动启动代理
sudo -u www nohup java -Xms128m -Xmx256m -jar /www/wwwroot/minilpa/app/minilpa-agent.jar \
  > /www/wwwroot/minilpa/logs/agent.log 2>&1 &

# 6. 查看代理日志
tail -f /www/wwwroot/minilpa/logs/agent.log
```

如果手动启动成功，说明问题在于systemd服务配置。

---

## 📝 生成诊断报告

执行以下命令生成完整的诊断信息：

```bash
cat > /tmp/minilpa-diagnostic.sh << 'EOF'
#!/bin/bash
echo "=== MiniLPA 部署诊断报告 ==="
echo "生成时间: $(date)"
echo ""
echo "=== 服务状态 ==="
systemctl status minilpa-backend --no-pager -l || echo "后端服务未找到"
echo ""
systemctl status minilpa-agent --no-pager -l || echo "代理服务未找到"
echo ""
echo "=== 文件检查 ==="
echo "后端JAR:"
ls -lh /www/wwwroot/minilpa/app/minilpa-backend.jar 2>&1
echo ""
echo "代理JAR:"
ls -lh /www/wwwroot/minilpa/app/minilpa-agent.jar 2>&1
echo ""
echo "=== Java环境 ==="
which java
java -version
echo ""
echo "=== 端口检查 ==="
netstat -tlnp | grep 8080 || echo "8080端口未监听"
echo ""
echo "=== 后端日志（最近20行） ==="
journalctl -u minilpa-backend -n 20 --no-pager 2>&1 || echo "无法获取后端日志"
echo ""
echo "=== 代理日志（最近20行） ==="
journalctl -u minilpa-agent -n 20 --no-pager 2>&1 || echo "无法获取代理日志"
EOF

chmod +x /tmp/minilpa-diagnostic.sh
sudo /tmp/minilpa-diagnostic.sh > /tmp/minilpa-diagnostic-report.txt
cat /tmp/minilpa-diagnostic-report.txt
```

然后将报告内容发送给我，我可以帮你进一步分析。

---

## ✅ 验证修复

修复后，验证步骤：

```bash
# 1. 检查服务状态（都应该是 active）
sudo systemctl status minilpa-backend --no-pager | grep Active
sudo systemctl status minilpa-agent --no-pager | grep Active

# 2. 测试后端API
curl http://127.0.0.1:8080/api/devices/status

# 3. 检查代理是否连接（应该返回 connected: true）
curl http://127.0.0.1:8080/api/devices/status | grep connected

# 4. 查看代理日志（应该看到"WebSocket连接已建立"）
sudo journalctl -u minilpa-agent -n 10 | grep -i "连接\|connected\|websocket"
```

如果所有检查都通过，前端应该能正常显示"已连接"状态。

